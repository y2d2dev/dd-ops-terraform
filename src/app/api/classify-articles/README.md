# リスク抽出・分類API ドメイン知識ドキュメント

## 概要
dd-opsの中核機能であるAIリスク抽出システムは、Google Gemini APIのFunction Calling機能を活用し、法務デューデリジェンスにおける契約書リスクを自動的に識別・分類します。

## 主要API

### `/api/classify-articles` - 条文単位リスク抽出（推奨）

#### ビジネス価値
- **精度向上**: 条文ごとに個別分析することで、見落としを防止
- **並列処理**: 複数条文を同時処理し、レスポンス時間を短縮
- **コンテキスト保持**: 契約書全体の文脈を考慮しながら条文単位で分析

#### 技術実装
```typescript
// 並列処理の実装
const classificationPromises = articles.map(article => 
  classifyArticle(article, riskTypes, contextInfo)
);
const results = await Promise.all(classificationPromises);
```

#### Function Calling設計
- **モデル**: gemini-2.0-pro-exp（最新の推論能力）
- **関数定義**: `classifyRisk`関数で構造化出力を強制
- **出力スキーマ**:
  ```json
  {
    "riskType": "リスクタイプID",
    "reason": "リスクの理由",
    "specificClause": "該当箇所の引用"
  }
  ```

### `/api/classify` - 全文一括分類（後方互換）

#### 使用場面
- 契約書全体の概要把握
- 初期スクリーニング
- レガシーシステムとの互換性維持

#### 制限事項
- 長文契約書では精度低下の可能性
- 条文の位置情報が不正確になる場合あり

## リスク分類体系

### デフォルトリスクタイプ
1. **契約解除リスク**: 不当な解除条項、一方的解除権
2. **損害賠償リスク**: 過大な賠償責任、無制限責任
3. **知的財産リスク**: 権利帰属の不明確さ、侵害責任
4. **機密保持リスク**: 不適切な情報開示、守秘義務違反
5. **競業避止リスク**: 過度な制限、不当な拘束
6. **保証責任リスク**: 過大な保証、瑕疵担保責任
7. **支払条件リスク**: 不利な支払条件、遅延損害金
8. **法的準拠リスク**: 不利な準拠法、管轄裁判所

### カスタムリスクタイプ
- ワークスペース単位で追加可能
- 業界特有のリスクに対応
- プロンプトのカスタマイズが可能

## AIプロンプト設計

### システムプロンプト構成
1. **役割定義**: 法務専門家としての立場を明確化
2. **分析対象**: 対象会社（targetCompany）の視点でリスク評価
3. **出力形式**: Function Callingによる構造化
4. **判断基準**: リスクタイプごとの具体的な判断基準

### コンテキスト情報の活用
```typescript
const contextInfo = {
  targetCompany: "買収対象会社名",
  contractTitle: "契約書タイトル",
  contractPreface: "前文（当事者情報）",
  userPrompt: "ユーザー追加指示"
};
```

## リスク検出ロジック

### 1. 条文前処理
- 改行・空白の正規化
- 条番号の抽出
- 関連条文の識別

### 2. リスク判定
- Gemini APIによる自然言語解析
- Function Callingで構造化データ取得
- 信頼度スコアによるフィルタリング

### 3. 位置情報の特定
- OCRデータとの照合
- ページ番号の特定
- テキスト位置（start/end）の計算

## パフォーマンス最適化

### 並列処理戦略
- 条文数に応じた動的バッチサイズ
- API レート制限の考慮
- タイムアウト処理（30秒）

### キャッシング
- リスクタイプ定義のメモリキャッシュ
- 分析結果の一時保存

## エラーハンドリング

### API エラー
- **429 Too Many Requests**: 自動リトライ with exponential backoff
- **503 Service Unavailable**: フォールバック処理
- **Timeout**: 部分的な結果を返却

### データ検証
- 空の条文はスキップ
- 不正な形式のレスポンスは除外
- 最低限の結果品質を保証

## 実装上の注意点

### Gemini API設定
```typescript
const model = genAI.getGenerativeModel({
  model: "gemini-2.0-pro-exp",
  generationConfig: {
    temperature: 0.2,  // 一貫性重視
    maxOutputTokens: 1000,
    responseMimeType: "application/json"
  }
});
```

### セキュリティ考慮
- APIキーの環境変数管理
- 入力サニタイゼーション
- 出力検証

## ビジネスインパクト

### 効率化指標
- **処理時間**: 手動レビューの1/10以下
- **網羅性**: 全条文を漏れなく分析
- **一貫性**: 判断基準の統一

### 品質向上
- 人的ミスの削減
- 見落としリスクの最小化
- レビュープロセスの標準化

## 今後の拡張可能性

### 機能拡張
- リスクレベル（高/中/低）の自動判定
- 関連条文の自動リンク
- リスク軽減策の提案

### AI モデル改善
- ファインチューニングによる精度向上
- 業界別モデルの開発
- マルチモーダル分析（図表対応）