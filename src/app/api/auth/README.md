# 認証API ドメイン知識ドキュメント

## 概要
dd-opsの認証システムは、JWTトークンベースの認証とワークスペース単位のIP制限を組み合わせた多層防御を実装しています。

## 認証フロー

### 1. ユーザー登録 (`/api/auth/register`)
- 新規ユーザーは必ずワークスペースに所属
- 登録時に自動的に「初期プロジェクト」が作成される
- パスワードはbcryptでハッシュ化

### 2. ログイン (`/api/auth/login`)
- メールアドレスとパスワードで認証
- 成功時、JWTトークンをHTTPOnlyクッキーに設定
- トークン有効期限：7日間
- トークンペイロード：
  ```json
  {
    "userId": 1,
    "email": "user@example.com"
  }
  ```

### 3. 認証状態確認 (`/api/auth/me`)
- 全ページで呼び出され、ユーザーの認証状態を確認
- IP制限チェックも同時に実施
- レスポンスにはユーザー情報とワークスペース情報を含む

### 4. ログアウト (`/api/auth/logout`)
- クッキーのmaxAgeを0に設定してトークンを無効化
- クライアント側でのリダイレクト処理が必要

## セキュリティ考慮事項

### JWT設計
- **保存場所**: HTTPOnlyクッキー（XSS対策）
- **署名アルゴリズム**: HS256
- **秘密鍵**: JWT_SECRET環境変数
- **有効期限**: 7日間（業務利用を考慮）

### IP制限
- ワークスペースレベルで設定
- `/api/auth/me`でチェック
- 許可IPリスト外からのアクセスは403エラー
- 法務DDの機密性を考慮した追加セキュリティ層

### パスワード管理
- bcryptによるハッシュ化（saltRounds: 10）
- プレーンテキストは一切保存しない
- パスワードリセット機能は未実装

## ビジネスルール

### ワークスペースとプロジェクト
1. **1ユーザー = 1ワークスペース**: 現在の実装では、ユーザーは単一のワークスペースに所属
2. **初期プロジェクト**: 登録時に「初期プロジェクト」が自動作成される
3. **プロジェクトユーザー関連**: ProjectUser表で多対多の関係を管理

### アクセス制御
- 認証が必要なAPIは、middlewareでJWT検証を実施
- 公開API（login, register, health等）は認証不要
- IP制限はワークスペース単位で適用

## エラーパターン

### 401 Unauthorized
- JWTトークンが無効/期限切れ
- トークンが存在しない

### 403 Forbidden  
- IP制限によるアクセス拒否
- ワークスペースへのアクセス権限なし

### 400 Bad Request
- メールアドレス重複（登録時）
- 必須パラメータ不足
- 不正なメールアドレス/パスワード形式

## 実装上の注意点

### クッキー設定
```typescript
httpOnly: true,    // XSS対策
secure: process.env.NODE_ENV === 'production', // HTTPS強制
sameSite: 'lax',   // CSRF対策
path: '/'          // 全パスで有効
```

### トランザクション処理
ユーザー登録時は以下を原子的に実行：
1. Userレコード作成
2. Projectレコード作成  
3. ProjectUserレコード作成

失敗時は全てロールバック

## 今後の拡張可能性

### 検討事項
- リフレッシュトークンの実装
- 2要素認証の追加
- パスワードリセット機能
- ソーシャルログイン連携
- セッション管理の強化

### 法務DD特有の要件
- 監査ログの記録
- アクセス履歴の保持
- 契約書閲覧権限の細分化
- 外部監査人向けの一時アクセス機能